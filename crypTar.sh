#!/bin/bash
set -e

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–∞
if [ -z "$1" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ –∑–∞–¥–∞–Ω –ø—É—Ç—å –¥–ª—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏."
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: crypTar /–ø—É—Ç—å/–∫/–ø–∞–ø–∫–µ_–∏–ª–∏_—Ñ–∞–π–ª—É"
    exit 1
fi

TARGET="$1"
ARCHIVE="$(basename "$TARGET")_$(date +%Y%m%d_%H%M%S).tar.gz"

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π
mapfile -t KEYS < <(gpg --list-keys --with-colons | awk -F: '/^pub/{pub=$5} /^uid/{print pub " : " $10}' )

# –ï—Å–ª–∏ –∫–ª—é—á–µ–π –Ω–µ—Ç ‚Äî –æ—à–∏–±–∫–∞ –∏ –≤—ã—Ö–æ–¥–∏–º
if [ ${#KEYS[@]} -eq 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ø—É–±–ª–∏—á–Ω—ã–µ GPG-–∫–ª—é—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –°–æ–∑–¥–∞–π—Ç–µ –∏—Ö —á–µ—Ä–µ–∑ install.sh"
    exit 1
fi

# –í—ã–≤–æ–¥–∏–º —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏
echo "üîë –ù–∞–π–¥–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –∫–ª—é—á–∏ GPG:"
for i in "${!KEYS[@]}"; do
    echo "[$i] ${KEYS[$i]}"
done

# –í—ã–±–æ—Ä –∫–ª—é—á–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –ø–æ –Ω–æ–º–µ—Ä—É
echo
read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–ª—é—á–∞ –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è: " KEY_INDEX

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –≤—ã–±–æ—Ä–∞
if ! [[ "$KEY_INDEX" =~ ^[0-9]+$ ]] || [ "$KEY_INDEX" -lt 0 ] || [ "$KEY_INDEX" -ge ${#KEYS[@]} ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –≤—ã–±—Ä–∞–Ω –Ω–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∫–ª—é—á–∞."
    exit 1
fi

SELECTED_KEY=$(echo "${KEYS[$KEY_INDEX]}" | awk -F ' : ' '{print $1}')

# –°–æ–∑–¥–∞—ë–º –∞—Ä—Ö–∏–≤
tar -czf "$ARCHIVE" "$TARGET"
echo "üì¶ –ê—Ä—Ö–∏–≤ $ARCHIVE —Å–æ–∑–¥–∞–Ω."

# –®–∏—Ñ—Ä—É–µ–º –∞—Ä—Ö–∏–≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∫–ª—é—á–æ–º
gpg --encrypt --recipient "$SELECTED_KEY" "$ARCHIVE"
rm -f "$ARCHIVE"

echo "‚úÖ –ê—Ä—Ö–∏–≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω –∫–ª—é—á–æ–º: ${KEYS[$KEY_INDEX]}"
