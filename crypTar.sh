#!/bin/bash
set -e

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–∞
if [ -z "$1" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ –∑–∞–¥–∞–Ω –ø—É—Ç—å –¥–ª—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏."
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: crypTar /–ø—É—Ç—å/–∫/–ø–∞–ø–∫–µ_–∏–ª–∏_—Ñ–∞–π–ª—É"
    exit 1
fi

TARGET="$1"
ARCHIVE="$(basename "$TARGET")_$(date +%Y%m%d_%H%M%S).tar.gz"

# –°–æ–∑–¥–∞—ë–º –∞—Ä—Ö–∏–≤
tar -czf "$ARCHIVE" "$TARGET"
echo "üì¶ –ê—Ä—Ö–∏–≤ $ARCHIVE —Å–æ–∑–¥–∞–Ω."

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π
KEYS=$(gpg --list-keys --with-colons | grep '^pub' | awk -F: '{print $5 " <" $10 ">"}')

# –ï—Å–ª–∏ –∫–ª—é—á–µ–π –Ω–µ—Ç ‚Äî –æ—à–∏–±–∫–∞ (—Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–ª—é—á –∑–¥–µ—Å—å **–Ω–µ –Ω—É–∂–Ω–æ**)
if [ -z "$KEYS" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ø—É–±–ª–∏—á–Ω—ã–µ GPG-–∫–ª—é—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –°–æ–∑–¥–∞–π—Ç–µ –∏—Ö —á–µ—Ä–µ–∑ install.sh"
    rm -f "$ARCHIVE"
    exit 1
fi

# –í—ã–≤–æ–¥–∏–º —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π
echo "üîë –ù–∞–π–¥–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –∫–ª—é—á–∏ GPG:"
echo "$KEYS"

# –í—ã–±–æ—Ä –∫–ª—é—á–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
echo
read -p "–í–≤–µ–¥–∏—Ç–µ email –∫–ª—é—á–∞, –∫–æ—Ç–æ—Ä—ã–º —Ö–æ—Ç–∏—Ç–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –∞—Ä—Ö–∏–≤: " RECIPIENT

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞
if ! echo "$KEYS" | grep -q "$RECIPIENT"; then
    echo "‚ùå –û—à–∏–±–∫–∞: –∫–ª—é—á —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω."
    rm -f "$ARCHIVE"
    exit 1
fi

# –®–∏—Ñ—Ä—É–µ–º –∞—Ä—Ö–∏–≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∫–ª—é—á–æ–º
gpg --encrypt --recipient "$RECIPIENT" "$ARCHIVE"
rm -f "$ARCHIVE"

echo "‚úÖ –ê—Ä—Ö–∏–≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω –∫–ª—é—á–æ–º $RECIPIENT."
