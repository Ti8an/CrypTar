#!/bin/bash

# === CrypTar - –∞—Ä—Ö–∏–≤–∞—Ç–æ—Ä —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º —á–µ—Ä–µ–∑ GPG ===

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä–µ–¥–∞–Ω –ª–∏ –∞—Ä–≥—É–º–µ–Ω—Ç
if [ -z "$1" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –ø–∞–ø–∫–∞ –∏–ª–∏ —Ñ–∞–π–ª –¥–ª—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏."
    echo "üëâ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: crypTar /–ø—É—Ç—å/–∫/–ø–∞–ø–∫–µ_–∏–ª–∏_—Ñ–∞–π–ª—É"
    exit 1
fi

TARGET="$1"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ
if [ ! -e "$TARGET" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø—É—Ç—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: $TARGET"
    exit 1
fi

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º—è –∞—Ä—Ö–∏–≤–∞
BASENAME=$(basename "$TARGET")
ARCHIVE="${BASENAME}_$(date +%Y%m%d_%H%M%S).tar.gz"
ENCRYPTED="${ARCHIVE}.gpg"

echo "üì¶ –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º: $TARGET ‚Üí $ARCHIVE"
tar -czf "$ARCHIVE" -C "$(dirname "$TARGET")" "$BASENAME"

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏!"
    exit 1
fi

# –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
echo "üîê –®–∏—Ñ—Ä—É–µ–º –∞—Ä—Ö–∏–≤..."
gpg --symmetric --cipher-algo AES256 "$ARCHIVE"

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–∏!"
    rm -f "$ARCHIVE"
    exit 1
fi

# –£–¥–∞–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∞—Ä—Ö–∏–≤
rm -f "$ARCHIVE"

echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –†–µ–∑—É–ª—å—Ç–∞—Ç: $ENCRYPTED"
