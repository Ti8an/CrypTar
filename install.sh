#!/bin/bash
set -e

echo "üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ CrypTar..."

# === –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —É—Ç–∏–ª–∏—Ç ===
for pkg in tar gpg; do
    if ! command -v $pkg &>/dev/null; then
        echo "‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º $pkg..."
        sudo apt-get install -y $pkg
    else
        echo "‚úÖ $pkg —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
    fi
done

# === –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—É—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ ===
if [ "$EUID" -eq 0 ]; then
    INSTALL_DIR="/usr/local/bin"
else
    INSTALL_DIR="$HOME/.local/bin"
    mkdir -p "$INSTALL_DIR"
fi

# === –ö–æ–ø–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç ===
SCRIPT_SOURCE="$(dirname "$0")/crypTar.sh"
SCRIPT_TARGET="$INSTALL_DIR/crypTar"

echo "üì¶ –ö–æ–ø–∏—Ä—É–µ–º $SCRIPT_SOURCE ‚Üí $SCRIPT_TARGET"
cp "$SCRIPT_SOURCE" "$SCRIPT_TARGET"
chmod +x "$SCRIPT_TARGET"

# === –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –≤ PATH –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ ===
if [[ ":$PATH:" != *":$INSTALL_DIR:"* ]]; then
    echo "üìÇ –î–æ–±–∞–≤–ª—è–µ–º $INSTALL_DIR –≤ PATH..."
    echo "export PATH=\"\$PATH:$INSTALL_DIR\"" >> "$HOME/.bashrc"
    export PATH="$PATH:$INSTALL_DIR"
fi

# === –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–ª—É—á–∞–π –¥–ª—è root ===
if [ "$EUID" -eq 0 ]; then
    if [ -d "/root/.local/bin" ] && [[ ":$PATH:" != *":/root/.local/bin:"* ]]; then
        echo "üìÇ –î–æ–±–∞–≤–ª—è–µ–º /root/.local/bin –≤ PATH..."
        echo 'export PATH=$PATH:/root/.local/bin' >> /root/.bashrc
        export PATH=$PATH:/root/.local/bin
    fi
fi

# === –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è GPG-–∫–ª—é—á–µ–π ===
KEYS=$(gpg --list-keys --with-colons | grep '^pub' | awk -F: '{print $5 " <" $10 ">"}')

if [ -z "$KEYS" ]; then
    echo
    echo "üîê GPG-–∫–ª—é—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!"
    echo "–•–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –∞—Ä—Ö–∏–≤–æ–≤? (y/n)"
    read -r CREATE_KEY
    if [[ "$CREATE_KEY" =~ ^[Yy]$ ]]; then
        gpg --full-generate-key
        echo "‚úÖ –ö–ª—é—á —Å–æ–∑–¥–∞–Ω! –í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –≤ crypTar."
    else
        echo "‚ö†Ô∏è –ë–µ–∑ –∫–ª—é—á–µ–π CrypTar —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ —Å–º–æ–∂–µ—Ç."
    fi
else
    echo
    echo "üîë –ù–∞–π–¥–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ GPG-–∫–ª—é—á–∏:"
    echo "$KEYS"
fi

echo
echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CrypTar —Ç–∞–∫:"
echo "üëâ crypTar /–ø—É—Ç—å/–∫/–ø–∞–ø–∫–µ_–∏–ª–∏_—Ñ–∞–π–ª—É"
